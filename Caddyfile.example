# Caddy 配置示例 - Bun Hono Server
# 替换 your-domain.com 为您的实际域名

your-domain.com {
    # 反向代理到 Bun Hono 应用
    reverse_proxy 127.0.0.1:4778 {
        # 健康检查（5分钟一次，适合稳定服务）
        health_uri /api/health
        health_interval 5m
        health_timeout 10s
        
        # 请求头传递
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }
    
    # 请求体大小限制（与应用内 MAX_FILE_SIZE 保持一致）
    request_body {
        max_size 10MB
    }
    
    # 启用压缩
    encode gzip zstd
    
    # CORS 配置
    @cors_preflight {
        method OPTIONS
    }
    handle @cors_preflight {
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
            Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
            Access-Control-Max-Age "86400"
        }
        respond 204
    }
    
    # 安全头部配置
    header {
        # 移除服务器信息
        -Server
        
        # 内容安全策略 (根据应用需求调整)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none'"
        
        # 基础安全头
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # HTTPS 强制 (仅在 HTTPS 环境下启用)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # 权限策略
        Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
        
        # CORS 头 (对所有请求)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Credentials "false"
    }
    
    # 上传文件安全策略（防止恶意文件执行）
    @uploads {
        path /uploads/*
    }
    handle @uploads {
        header {
            # 防止上传文件被当作脚本执行
            Content-Security-Policy "default-src 'none'; style-src 'unsafe-inline'"
            X-Content-Type-Options "nosniff"
            X-Download-Options "noopen"
            # 长期缓存（文件内容不变）
            Cache-Control "public, max-age=31536000, immutable"
        }
        reverse_proxy 127.0.0.1:4778
    }
}

# HTTP 到 HTTPS 重定向 (推荐)
http://your-domain.com {
    redir https://your-domain.com{uri} permanent
}